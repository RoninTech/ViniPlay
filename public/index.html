<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViniPlay IPTV Player</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/o1cAhBo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js/dist/mpegts.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        /* Custom scrollbar for desktop */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Active state for tabs */
        .tab-button.active { background-color: #3b82f6; color: white; }
        .bottom-nav-btn.active { color: #3b82f6; }
        .data-tab-button.active { color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6; }

        .programme-item { border-left: 3px solid #3b82f6; transition: background-color 0.3s, border-color 0.3s, opacity 0.3s; }
        .programme-item:hover { background-color: #374151; cursor: pointer; }
        html, body { height: 100%; overflow: hidden; }
        
        .favorite-star { transition: color 0.2s, transform 0.2s; }
        .favorite-star.favorited { color: #facc15; /* yellow-400 */ transform: scale(1.2); }
        
        /* Progress bar inside the programme item */
        .programme-progress {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            background-color: rgba(59, 130, 246, 0.3); /* blue-500 with opacity */
            border-radius: 2px 0 0 2px;
            pointer-events: none;
            transition: width 0.3s linear;
        }

        /* Style for past programs */
        .programme-item.past {
            background-color: #374151; /* gray-700 */
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.6;
        }
        
        /* Visual Hierarchy Improvements */
        .programme-item.live {
            border-left: 4px solid #fb923c; /* orange-400 */
            background-color: #374151;
        }
        .programme-item.live::after {
            content: 'LIVE';
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 1px 4px;
            font-size: 0.65rem; /* 10.4px */
            font-weight: 700;
            border-radius: 4px;
            z-index: 20;
        }
        .programme-item .prog-title {
            font-size: 0.9rem; /* 14.4px */
            font-weight: 600;
        }
        .programme-item .prog-time {
            font-size: 0.75rem; /* 12px */
        }
        
        /* Interactive Feedback */
        #group-filter, #search-input, #timezone-offset-select {
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #group-filter:hover, #search-input:hover, #timezone-offset-select:hover {
            background-color: #4b5563; /* gray-600 */
        }

        /* Transition for off-canvas sidebar */
        #channel-panel-container { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }

        /* Prevent scrolling on the body when a modal is open */
        body.modal-open {
            overflow: hidden;
        }

        .programme-item.highlighted {
            outline: 3px solid #facc15; /* yellow-400 */
            z-index: 15; /* Ensure highlight is on top */
            transition: outline 0.2s ease-in-out;
        }

    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 shadow-md z-30 flex-shrink-0 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="https://i.imgur.com/o1cAhBo.png" alt="ViniPlay Logo" class="h-8 w-8">
            <h1 class="text-xl sm:text-2xl font-bold">ViniPlay</h1>
        </div>
        <!-- Mobile Sidebar Toggle -->
        <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md hover:bg-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </header>

    <!-- Desktop Main Tabs -->
    <div class="hidden lg:flex border-b border-gray-700 bg-gray-800 flex-shrink-0 z-20">
        <button id="tab-guide" class="tab-button text-sm sm:text-base font-medium py-3 px-6 text-gray-300 hover:bg-gray-700 transition-colors duration-200">TV Guide</button>
        <button id="tab-settings" class="tab-button text-sm sm:text-base font-medium py-3 px-6 text-gray-300 hover:bg-gray-700 transition-colors duration-200 active">Settings</button>
    </div>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col overflow-hidden">
        <!-- TV Guide Page -->
        <div id="page-guide" class="hidden flex-grow flex-col overflow-hidden">
             <!-- Guide Controls -->
            <div class="flex flex-wrap items-center justify-between gap-4 p-2 sm:p-4 border-b border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <button id="prev-day-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">&lt;</button>
                    <button id="now-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Now</button>
                    <button id="next-day-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">&gt;</button>
                </div>
                <div id="guide-date-display" class="text-base sm:text-lg font-semibold text-center flex-grow"></div>
                <div class="relative w-full sm:w-auto flex items-center gap-2">
                    <input type="search" id="search-input" placeholder="Search channels & programs..." class="w-full sm:w-64 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:ring-blue-500 focus:border-blue-500">
                    <button id="today-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors flex-shrink-0">Reset view</button>
                    <!-- Enhanced Search Results Container -->
                    <div id="search-results-container" class="hidden absolute top-full right-0 w-full sm:w-96 max-h-80 overflow-y-auto bg-gray-800 border border-gray-600 rounded-md mt-1 z-50 custom-scrollbar shadow-lg">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
            </div>
            <!-- Guide Container -->
            <div id="guide-container" class="flex-grow flex bg-gray-900 overflow-hidden relative">
                <div id="guide-placeholder" class="absolute inset-0 flex items-center justify-center z-40">
                    <div id="placeholder-content" class="text-center text-gray-500 p-4">
                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <h3 class="mt-2 text-sm font-medium">No Data Loaded</h3>
                        <p class="mt-1 text-sm">Go to the Settings tab to load your M3U and EPG files.</p>
                    </div>
                </div>

                <!-- Channel Panel (Sidebar on mobile, column on desktop) -->
                <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>
                <div id="channel-panel-container" class="absolute lg:relative inset-y-0 left-0 w-64 sm:w-80 bg-gray-800/80 lg:bg-gray-800 backdrop-blur-sm lg:backdrop-blur-none z-50 transform -translate-x-full lg:transform-none lg:translate-x-0 min-w-[250px] max-w-[80vw] lg:max-w-[30vw] flex-shrink-0 flex flex-col hidden lg:flex">
                    <div class="h-16 flex items-center justify-between p-2 border-b border-gray-700/80 flex-shrink-0">
                         <select id="group-filter" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500 hidden"></select>
                    </div>
                    <div id="channel-list" class="overflow-y-auto custom-scrollbar flex-grow"></div>
                </div>
            
                <div id="resizer" class="hidden lg:block w-1.5 cursor-col-resize bg-gray-700 hover:bg-blue-500 transition-colors duration-200 z-10"></div>
                
                 <!-- Mobile-only sticky Logo Column -->
                <div id="logo-column" class="flex flex-col lg:hidden w-20 flex-shrink-0 bg-gray-900 border-r border-gray-700/50">
                    <div class="h-16 flex-shrink-0 border-b border-gray-700/80"></div> <!-- Spacer for time bar -->
                    <div id="logo-list" class="overflow-y-auto custom-scrollbar flex-grow"></div>
                </div>

                <div id="timeline-container" class="flex-grow flex flex-col overflow-hidden">
                    <div id="time-bar" class="h-16 bg-gray-800/80 flex-shrink-0 relative z-10 overflow-x-hidden"></div>
                    <div id="guide-timeline" class="overflow-auto custom-scrollbar relative flex-grow">
                        <div id="now-line" class="absolute top-0 bottom-0 bg-red-500 w-0.5 z-20 hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="flex-grow flex-col items-center p-4 overflow-y-auto custom-scrollbar">
            <div class="w-full max-w-4xl mx-auto space-y-8 pb-16"> <!-- Padding bottom for mobile nav -->
                <!-- File Upload and Loading Section -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Load Guide Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">1. M3U Source</label>
                            <div class="flex border-b border-gray-600">
                                <button id="m3u-tab-file" class="data-tab-button flex-1 py-2 text-sm">From File</button>
                                <button id="m3u-tab-url" class="data-tab-button active flex-1 py-2 text-sm">From URL</button>
                            </div>
                            <div id="m3u-content-file" class="hidden mt-4"><input type="file" id="m3u-upload" accept=".m3u,.m3u8" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer"></div>
                            <div id="m3u-content-url" class="mt-4">
                                <div class="space-y-2">
                                    <select id="m3u-url-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="custom">Custom URL...</option>
                                    </select>
                                    <div id="m3u-custom-container" class="hidden flex gap-2">
                                        <input type="url" id="m3u-url-input" placeholder="Enter custom M3U URL..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <button id="save-m3u-url-btn" title="Save URL to list" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md flex-shrink-0">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">2. EPG Source (Optional)</label>
                                <div class="flex border-b border-gray-600">
                                    <button id="epg-tab-file" class="data-tab-button flex-1 py-2 text-sm">From File</button>
                                    <button id="epg-tab-url" class="data-tab-button active flex-1 py-2 text-sm">From URL</button>
                                </div>
                            <div id="epg-content-file" class="hidden mt-4"><input type="file" id="epg-upload" accept=".xml,.xmltv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer"></div>
                            <div id="epg-content-url" class="mt-4">
                                <div class="space-y-2">
                                    <select id="epg-url-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="custom">Custom URL...</option>
                                    </select>
                                    <div id="epg-custom-container" class="hidden flex gap-2">
                                        <input type="url" id="epg-url-input" placeholder="Enter custom EPG URL..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <button id="save-epg-url-btn" title="Save URL to list" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md flex-shrink-0">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <button id="load-guide-btn" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2">
                                <span id="load-guide-btn-content">
                                    <svg class="w-5 h-5 inline-block -mt-1 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    <span>Load Guide & View</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NEW: FFmpeg Settings Section -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Streaming Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ffmpeg-profile-select" class="block text-sm font-medium text-gray-400 mb-1">Streaming Profile</label>
                            <p class="text-xs text-gray-500 mb-2">'Proxy' is fastest but may not work for all streams. 'Transcode' is more compatible.</p>
                            <select id="ffmpeg-profile-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="transcode">Transcode (Default, Compatible)</option>
                                <option value="proxy">Proxy (Fast, Direct Stream)</option>
                                <option value="custom">Custom FFmpeg Arguments</option>
                            </select>
                        </div>
                        <div id="ffmpeg-custom-args-container" class="hidden">
                            <label for="ffmpeg-custom-args-input" class="block text-sm font-medium text-gray-400 mb-1">Custom FFmpeg Arguments</label>
                            <p class="text-xs text-amber-400 mb-2">Warning: Advanced use only. Invalid arguments may break streaming. Do not include `-i input_url` or `pipe:1`.</p>
                            <textarea id="ffmpeg-custom-args-input" rows="3" placeholder="-c:v hevc_nvenc -preset slow..." class="w-full bg-gray-900 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <!-- App Settings Section -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">General Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="auto-refresh-select" class="block text-sm font-medium text-gray-400 mb-1">Auto Refresh URL Data</label>
                            <select id="auto-refresh-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">Disabled</option>
                                <option value="1">Every 1 Hour</option>
                                <option value="4">Every 4 Hours</option>
                                <option value="12">Every 12 Hours</option>
                                <option value="24">Every 24 Hours</option>
                            </select>
                        </div>
                        <div>
                            <label for="timezone-offset-select" class="block text-sm font-medium text-gray-400 mb-1">EPG Timezone Correction</label>
                             <p class="text-xs text-gray-500 mb-2">Use this if EPG times are wrong. It only affects programs that don't have their own timezone info.</p>
                            <select id="timezone-offset-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
            
                <!-- Danger Zone Section -->
                <div class="bg-red-900/50 border border-red-700/50 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-red-300 mb-4 border-b border-red-700/50 pb-2">Danger Zone</h2>
                    <p class="text-sm text-gray-400 mb-4">This will permanently delete all saved application data from this browser.</p>
                    <button id="clear-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Clear All Data & Reset</span></button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="lg:hidden bg-gray-800 border-t border-gray-700 flex justify-around flex-shrink-0 z-20">
        <button id="bottom-nav-guide" class="bottom-nav-btn flex-1 p-3 text-gray-400">
            <svg class="mx-auto h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            <span class="text-xs">Guide</span>
        </button>
        <button id="bottom-nav-settings" class="bottom-nav-btn flex-1 p-3 text-gray-400 active">
            <svg class="mx-auto h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-xs">Settings</span>
        </button>
    </nav>


    <!-- Modals -->
    <div id="video-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 id="video-title" class="text-lg font-semibold text-white truncate"></h3>
                <div class="flex items-center gap-2">
                    <button id="pip-btn" class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-700" title="Picture-in-Picture">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M12.5 5.5h-5a1 1 0 00-1 1v2.5a.5.5 0 001 0v-2a.5.5 0 01.5-.5h4a.5.5 0 01.5.5v4a.5.5 0 01-.5.5h-2a.5.5 0 000 1h2.5a1 1 0 001-1v-5a1 1 0 00-1-1z"></path><path d="M3.5 3A1.5 1.5 0 002 4.5v11A1.5 1.5 0 003.5 17h13a1.5 1.5 0 001.5-1.5v-11A1.5 1.5 0 0016.5 3h-13zm0 1h13a.5.5 0 01.5.5v11a.5.5 0 01-.5.5h-13a.5.5 0 01-.5-.5v-11a.5.5 0 01.5-.5z"></path></svg>
                    </button>
                    <button id="close-modal" class="text-gray-400 hover:text-white text-3xl leading-none font-bold">&times;</button>
                </div>
            </div>
            <div class="flex-grow p-1 bg-black"><video id="videoElement" controls autoplay class="w-full h-full"></video></div>
        </div>
    </div>
    
    <div id="program-details-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="details-title" class="text-xl font-bold text-white mb-2">Program Title</h3>
            <p id="details-time" class="text-sm text-gray-400 mb-4">Time Info</p>
            <p id="details-desc" class="text-base text-gray-300 mb-6 max-h-40 overflow-y-auto custom-scrollbar"></p>
            <div class="flex justify-between items-center gap-4">
                <button id="details-play-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Play Channel</button>
                <button id="details-close-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="hidden fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-[100]">
        <p id="notification-message"></p>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="confirm-title" class="text-lg font-bold text-white mb-2">Are you sure?</h3>
            <p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- This script tag contains the parser logic which will be run in a separate thread -->
    <script id="parser-worker" type="javascript/worker">
        // --- Web Worker for Parsing M3U and EPG files ---
        
        function parseEpgTime(timeStr, offsetHours = 0) {
            const match = timeStr.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s*(([+-])(\d{2})(\d{2}))?/);
            if (match) {
                const [ , year, month, day, hours, minutes, seconds, , sign, tzHours, tzMinutes] = match;
                let date;
                if (sign && tzHours && tzMinutes) {
                    const epgOffsetMinutes = (parseInt(tzHours) * 60 + parseInt(tzMinutes)) * (sign === '+' ? 1 : -1);
                    date = new Date(Date.UTC(year, parseInt(month) - 1, day, hours, minutes, seconds));
                    date.setUTCMinutes(date.getUTCMinutes() - epgOffsetMinutes);
                } else {
                    date = new Date(Date.UTC(year, parseInt(month) - 1, day, hours, minutes, seconds));
                    date.setUTCHours(date.getUTCHours() - offsetHours);
                }
                return date;
            }
            if (timeStr.length >= 14) {
                 const date = new Date(Date.UTC(
                    timeStr.substring(0, 4), parseInt(timeStr.substring(4, 6)) - 1, timeStr.substring(6, 8),
                    timeStr.substring(8, 10), timeStr.substring(10, 12), timeStr.substring(12, 14)
                ));
                date.setUTCHours(date.getUTCHours() - offsetHours);
                return date;
            }
            return new Date();
        }

        function parseM3U(data) {
            const lines = data.split('\n');
            const channels = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('#EXTINF:')) {
                    const nextLine = lines[i + 1]?.trim();
                    if (nextLine && (nextLine.startsWith('http') || nextLine.startsWith('rtp'))) {
                        const idMatch = line.match(/tvg-id="([^"]*)"/);
                        const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                        const nameMatch = line.match(/tvg-name="([^"]*)"/);
                        const groupMatch = line.match(/group-title="([^"]*)"/);
                        const commaIndex = line.lastIndexOf(',');
                        const displayName = (commaIndex !== -1) ? line.substring(commaIndex + 1).trim() : 'Unknown Channel';

                        channels.push({
                            id: idMatch ? idMatch[1] : `unknown-${channels.length}`,
                            logo: logoMatch ? logoMatch[1] : '',
                            name: nameMatch ? nameMatch[1] : displayName,
                            group: groupMatch ? groupMatch[1] : 'Uncategorized',
                            displayName: displayName,
                            url: nextLine
                        });
                        i++;
                    }
                }
            }
            return channels;
        }

        function parseEPG(xmlString, timezoneOffset) {
            const programData = {};
            const programmeRegex = /<programme([^>]+)>([\s\S]*?)<\/programme>/g;
            const channelRegex = /channel="([^"]+)"/;
            const startRegex = /start="([^"]+)"/;
            const stopRegex = /stop="([^"]+)"/;
            const titleRegex = /<title[^>]*>([\s\S]*?)<\/title>/;
            const descRegex = /<desc[^>]*>([\s\S]*?)<\/desc>/;

            let match;
            while ((match = programmeRegex.exec(xmlString)) !== null) {
                const [ , attributes, content] = match;
                const channelMatch = attributes.match(channelRegex);
                const startMatch = attributes.match(startRegex);
                const stopMatch = attributes.match(stopRegex);

                if (!channelMatch || !startMatch || !stopMatch) continue;

                const channelId = channelMatch[1];
                const titleMatch = content.match(titleRegex);
                const descMatch = content.match(descRegex);
                const title = titleMatch ? titleMatch[1].replace(/<!\[CDATA\[|\]\]>/g, '').trim() : 'No Title';
                const desc = descMatch ? descMatch[1].replace(/<!\[CDATA\[|\]\]>/g, '').trim() : '';

                if (!programData[channelId]) {
                    programData[channelId] = [];
                }
                
                programData[channelId].push({
                    start: parseEpgTime(startMatch[1], timezoneOffset),
                    stop: parseEpgTime(stopMatch[1], timezoneOffset),
                    title,
                    desc
                });
            }

            for (const channelId in programData) {
                programData[channelId].sort((a, b) => a.start - b.start);
            }
            return programData;
        }

        self.onmessage = function(e) {
            const { type, data, timezoneOffset } = e.data;
            try {
                if (type === 'm3u') {
                    self.postMessage({ type: 'm3u-success', data: parseM3U(data) });
                } else if (type === 'epg') {
                    self.postMessage({ type: 'epg-success', data: parseEPG(data, timezoneOffset) });
                }
            } catch (error) {
                self.postMessage({ type: 'parse-error', error: error.message });
            }
        };
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Globals
            const guideState = {
                channels: [],
                programs: {},
                favorites: [],
                recentChannels: [],
                timezoneOffset: 0,
                guideDurationHours: 48,
                hourWidthPixels: window.innerWidth < 768 ? 200 : 300,
                currentDate: new Date(),
                channelGroups: new Set(),
                // NEW: Add ffmpeg settings to the state
                ffmpeg: {
                    profile: 'transcode', // default
                    customArgs: ''
                }
            };
            let player;
            let worker;
            let autoRefreshIntervalId = null;
            let searchDebounceTimer = null;

            // --- IndexedDB Storage Helper ---
            const dbName = 'iptvGuideDB';
            const storeName = 'guideData';
            let db;

            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(dbName, 3);
                    request.onerror = (event) => reject("IndexedDB error: " + request.error);
                    request.onsuccess = (event) => { db = event.target.result; resolve(db); };
                    request.onupgradeneeded = (event) => {
                        const dbHandle = event.target.result;
                        if (!dbHandle.objectStoreNames.contains(storeName)) {
                            dbHandle.createObjectStore(storeName, { keyPath: 'id' });
                        }
                    };
                });
            }

            function saveDataToDB(id, content) {
                return new Promise((resolve, reject) => {
                    if (!db) { reject("DB not initialized"); return; }
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put({ id, content });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            function loadDataFromDB(id) {
                return new Promise((resolve, reject) => {
                    if (!db) { reject("DB not initialized"); return; }
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result ? request.result.content : null);
                    request.onerror = () => reject(request.error);
                });
            }

            function clearDB() {
                return new Promise((resolve, reject) => {
                    if (!db) { reject("DB not initialized"); return; }
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            // --- Get All DOM Elements ---
            const UIElements = {
                body: document.body,
                tabGuide: document.getElementById('tab-guide'),
                tabSettings: document.getElementById('tab-settings'),
                bottomNavGuide: document.getElementById('bottom-nav-guide'),
                bottomNavSettings: document.getElementById('bottom-nav-settings'),
                pageGuide: document.getElementById('page-guide'),
                pageSettings: document.getElementById('page-settings'),
                loadGuideBtn: document.getElementById('load-guide-btn'),
                m3uUrlSelect: document.getElementById('m3u-url-select'),
                m3uCustomContainer: document.getElementById('m3u-custom-container'),
                m3uUrlInput: document.getElementById('m3u-url-input'),
                saveM3uUrlBtn: document.getElementById('save-m3u-url-btn'),
                epgUrlSelect: document.getElementById('epg-url-select'),
                epgCustomContainer: document.getElementById('epg-custom-container'),
                epgUrlInput: document.getElementById('epg-url-input'),
                saveEpgUrlBtn: document.getElementById('save-epg-url-btn'),
                clearDataBtn: document.getElementById('clear-data-btn'),
                channelListDiv: document.getElementById('channel-list'),
                logoList: document.getElementById('logo-list'),
                timeBarDiv: document.getElementById('time-bar'),
                guideTimelineDiv: document.getElementById('guide-timeline'),
                guidePlaceholder: document.getElementById('guide-placeholder'),
                videoModal: document.getElementById('video-modal'),
                videoElement: document.getElementById('videoElement'),
                videoTitle: document.getElementById('video-title'),
                closeModalBtn: document.getElementById('close-modal'),
                pipBtn: document.getElementById('pip-btn'),
                notificationModal: document.getElementById('notification-modal'),
                notificationMessage: document.getElementById('notification-message'),
                confirmModal: document.getElementById('confirm-modal'),
                autoRefreshSelect: document.getElementById('auto-refresh-select'),
                timezoneOffsetSelect: document.getElementById('timezone-offset-select'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                // NEW: FFmpeg UI Elements
                ffmpegProfileSelect: document.getElementById('ffmpeg-profile-select'),
                ffmpegCustomArgsContainer: document.getElementById('ffmpeg-custom-args-container'),
                ffmpegCustomArgsInput: document.getElementById('ffmpeg-custom-args-input'),
            };

            // Simplified querySelectorAll
            const $$ = (selector) => document.querySelectorAll(selector);

            // --- General Functions (Tabs, Modals, etc.) ---
            function showNotification(message, isError = false, duration = 3000) {
                UIElements.notificationMessage.textContent = message;
                UIElements.notificationModal.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            }

            function switchTab(activeTab) {
                const isGuide = activeTab === 'guide';
                $$('.tab-button, .bottom-nav-btn').forEach(el => el.classList.remove('active'));
                $$(`#tab-${activeTab}, #bottom-nav-${activeTab}`).forEach(el => el.classList.add('active'));
                UIElements.pageGuide.classList.toggle('hidden', !isGuide);
                UIElements.pageGuide.classList.toggle('flex', isGuide);
                UIElements.pageSettings.classList.toggle('hidden', isGuide);
                UIElements.pageSettings.classList.toggle('flex', !isGuide);
                UIElements.sidebarToggle.classList.toggle('hidden', !isGuide);
            }

            function openModal(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('modal-open');
            }

            function closeModal(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (!document.querySelector('.fixed.flex')) {
                    document.body.classList.remove('modal-open');
                }
            }

            // --- Player & Stream Logic ---
            function stopAndCleanupPlayer() {
                if (player) {
                    try { player.destroy(); } catch (e) { console.error("Error destroying player:", e); }
                    player = null;
                }
                UIElements.videoElement.src = "";
                UIElements.videoElement.removeAttribute('src');
                UIElements.videoElement.load();
                if (document.pictureInPictureElement) {
                    document.exitPictureInPicture().catch(e => console.error("Failed to exit PiP:", e));
                }
            }

            async function playChannel(url, name, channelId) {
                stopAndCleanupPlayer();
                
                if (channelId) {
                    guideState.recentChannels = [channelId, ...guideState.recentChannels.filter(id => id !== channelId)].slice(0, 10);
                    await saveDataToDB('recentChannels', guideState.recentChannels);
                }

                // MODIFIED: Construct the stream URL with the selected profile and custom args
                const profile = guideState.ffmpeg.profile;
                const customArgs = guideState.ffmpeg.customArgs;
                let finalUrl = `/stream?url=${encodeURIComponent(url)}&profile=${profile}`;
                if (profile === 'custom' && customArgs) {
                    finalUrl += `&args=${encodeURIComponent(customArgs)}`;
                }

                if (mpegts.isSupported()) {
                    player = mpegts.createPlayer({ type: 'mse', isLive: true, url: finalUrl });
                    openModal(UIElements.videoModal);
                    UIElements.videoTitle.textContent = name;
                    player.attachMediaElement(UIElements.videoElement);
                    player.load();
                    UIElements.videoElement.volume = parseFloat(localStorage.getItem('iptvPlayerVolume') || 0.5);
                    player.play().catch(e => {
                        showNotification("Could not play stream. Check server logs.", true);
                        closeModal(UIElements.videoModal);
                        stopAndCleanupPlayer();
                    });
                } else {
                    showNotification('Browser does not support Media Source Extensions (MSE).', true);
                }
            }

            // --- Settings & Data Handling ---
            async function saveFFmpegSettings() {
                guideState.ffmpeg.profile = UIElements.ffmpegProfileSelect.value;
                guideState.ffmpeg.customArgs = UIElements.ffmpegCustomArgsInput.value;
                await saveDataToDB('ffmpegSettings', guideState.ffmpeg);
                showNotification('Streaming settings saved.');
            }

            // --- Event Listeners Setup ---
            function setupEventListeners() {
                // ... (keep all your existing event listeners for tabs, modals, guide, etc.)

                // NEW: Event Listeners for FFmpeg Settings
                UIElements.ffmpegProfileSelect.addEventListener('change', () => {
                    const isCustom = UIElements.ffmpegProfileSelect.value === 'custom';
                    UIElements.ffmpegCustomArgsContainer.classList.toggle('hidden', !isCustom);
                    saveFFmpegSettings();
                });

                let customArgsDebounce;
                UIElements.ffmpegCustomArgsInput.addEventListener('input', () => {
                    clearTimeout(customArgsDebounce);
                    customArgsDebounce = setTimeout(saveFFmpegSettings, 500);
                });

                // ... (the rest of your setupEventListeners function)
            }

            // --- App Initialization ---
            async function initApp() {
                try {
                    await initDB();
                    // ... (rest of your initDB logic)

                    const [
                        loadedChannels, loadedPrograms, favorites, autoRefresh,
                        customM3uUrls, customEpgUrls, lastM3uUrl, lastEpgUrl,
                        recentChannels, timezoneOffset, 
                        ffmpegSettings // NEW: Load ffmpeg settings
                    ] = await Promise.all([
                        loadDataFromDB('parsedChannels'), loadDataFromDB('parsedPrograms'),
                        loadDataFromDB('favorites'), loadDataFromDB('autoRefresh'),
                        loadDataFromDB('customM3uUrls'), loadDataFromDB('customEpgUrls'),
                        loadDataFromDB('lastM3uUrl'), loadDataFromDB('lastEpgUrl'),
                        loadDataFromDB('recentChannels'), loadDataFromDB('timezoneOffset'),
                        loadDataFromDB('ffmpegSettings') // NEW
                    ]);

                    // ... (rest of your data loading logic for m3u, epg, etc.)

                    // NEW: Apply loaded FFmpeg settings
                    if (ffmpegSettings) {
                        guideState.ffmpeg = ffmpegSettings;
                        UIElements.ffmpegProfileSelect.value = guideState.ffmpeg.profile;
                        UIElements.ffmpegCustomArgsInput.value = guideState.ffmpeg.customArgs;
                        UIElements.ffmpegCustomArgsContainer.classList.toggle('hidden', guideState.ffmpeg.profile !== 'custom');
                    }
                    
                    // ... (rest of your initApp function)

                } catch (e) {
                    console.error("Initialization failed:", e);
                    // ...
                }
                setupEventListeners();
            }
            
            // Your other functions like handleGuideLoad, renderGuide, etc. remain the same.
            // Just ensure the new UI elements are handled correctly in setupEventListeners and initApp.
            // All other functions are omitted for brevity but should be kept from your original file.
            // The full script is too long to repeat, so only showing the necessary changes.
            
            // This is a placeholder for the rest of your JS logic which should be copied here.
            // Ensure you integrate the new elements and logic shown above into your full script.
            // ... (The entire rest of your script goes here)
            
            // Make sure to call initApp at the end
            initApp();
        });
    </script>
</body>
</html>
