<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViniPlay IPTV Player</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/o1cAhBo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js/dist/mpegts.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .tab-button.active { background-color: #3b82f6; color: white; }
        .bottom-nav-btn.active { color: #3b82f6; }
        .data-tab-button.active { color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6; }

        .programme-item { border-left: 3px solid #3b82f6; transition: background-color 0.3s, border-color 0.3s, opacity 0.3s; }
        .programme-item:hover { background-color: #374151; cursor: pointer; }
        html, body { height: 100%; overflow: hidden; }
        
        .favorite-star { transition: color 0.2s, transform 0.2s; }
        .favorite-star.favorited { color: #facc15; transform: scale(1.2); }
        
        .programme-progress {
            position: absolute; top: 0; left: 0; bottom: 0;
            background-color: rgba(59, 130, 246, 0.3);
            border-radius: 2px 0 0 2px;
            pointer-events: none; transition: width 0.3s linear;
        }
        .programme-item.past { background-color: #374151; border-left-color: #6b7280; opacity: 0.6; }
        .programme-item.live { border-left: 4px solid #fb923c; background-color: #374151; }
        .programme-item.live::after {
            content: 'LIVE'; position: absolute; top: 4px; right: 4px;
            background-color: #ef4444; color: white; padding: 1px 4px;
            font-size: 0.65rem; font-weight: 700; border-radius: 4px; z-index: 20;
        }
        .programme-item .prog-title { font-size: 0.9rem; font-weight: 600; }
        .programme-item .prog-time { font-size: 0.75rem; }
        
        #channel-panel-container { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        body.modal-open { overflow: hidden; }
        .programme-item.highlighted { outline: 3px solid #facc15; z-index: 15; transition: outline 0.2s ease-in-out; }
        .table-action-btn { transition: background-color 0.2s; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 shadow-md z-30 flex-shrink-0 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="https://i.imgur.com/o1cAhBo.png" alt="ViniPlay Logo" class="h-8 w-8">
            <h1 class="text-xl sm:text-2xl font-bold">ViniPlay</h1>
        </div>
        <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md hover:bg-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </header>

    <!-- Desktop Main Tabs -->
    <div class="hidden lg:flex border-b border-gray-700 bg-gray-800 flex-shrink-0 z-20">
        <button id="tab-guide" class="tab-button text-sm sm:text-base font-medium py-3 px-6 text-gray-300 hover:bg-gray-700 transition-colors duration-200">TV Guide</button>
        <button id="tab-settings" class="tab-button text-sm sm:text-base font-medium py-3 px-6 text-gray-300 hover:bg-gray-700 transition-colors duration-200 active">Settings</button>
    </div>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col overflow-hidden">
        <!-- TV Guide Page -->
        <div id="page-guide" class="hidden flex-grow flex-col overflow-hidden">
             <!-- Guide Controls -->
            <div class="flex flex-wrap items-center justify-between gap-4 p-2 sm:p-4 border-b border-gray-700 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <button id="prev-day-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">&lt;</button>
                    <button id="now-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Now</button>
                    <button id="next-day-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">&gt;</button>
                </div>
                <div id="guide-date-display" class="text-base sm:text-lg font-semibold text-center flex-grow"></div>
                <div class="relative w-full sm:w-auto flex items-center gap-2">
                    <input type="search" id="search-input" placeholder="Search channels & programs..." class="w-full sm:w-64 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:ring-blue-500 focus:border-blue-500">
                    <button id="today-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors flex-shrink-0">Reset view</button>
                    <div id="search-results-container" class="hidden absolute top-full right-0 w-full sm:w-96 max-h-80 overflow-y-auto bg-gray-800 border border-gray-600 rounded-md mt-1 z-50 custom-scrollbar shadow-lg"></div>
                </div>
            </div>
            <!-- Guide Container -->
            <div id="guide-container" class="flex-grow flex bg-gray-900 overflow-hidden relative">
                <div id="guide-placeholder" class="absolute inset-0 flex items-center justify-center z-40">
                    <div id="placeholder-content" class="text-center text-gray-500 p-4">
                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <h3 class="mt-2 text-sm font-medium">No Data Loaded</h3>
                        <p class="mt-1 text-sm">Go to the Settings tab to load your M3U and EPG files.</p>
                    </div>
                </div>
                <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>
                <div id="channel-panel-container" class="absolute lg:relative inset-y-0 left-0 w-64 sm:w-80 bg-gray-800/80 lg:bg-gray-800 backdrop-blur-sm lg:backdrop-blur-none z-50 transform -translate-x-full lg:transform-none lg:translate-x-0 min-w-[250px] max-w-[80vw] lg:max-w-[30vw] flex-shrink-0 flex flex-col hidden lg:flex">
                    <div class="h-16 flex items-center justify-between p-2 border-b border-gray-700/80 flex-shrink-0">
                         <select id="group-filter" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500 hidden"></select>
                    </div>
                    <div id="channel-list" class="overflow-y-auto custom-scrollbar flex-grow"></div>
                </div>
                <div id="resizer" class="hidden lg:block w-1.5 cursor-col-resize bg-gray-700 hover:bg-blue-500 transition-colors duration-200 z-10"></div>
                <div id="logo-column" class="flex flex-col lg:hidden w-20 flex-shrink-0 bg-gray-900 border-r border-gray-700/50">
                    <div class="h-16 flex-shrink-0 border-b border-gray-700/80"></div>
                    <div id="logo-list" class="overflow-y-auto custom-scrollbar flex-grow"></div>
                </div>
                <div id="timeline-container" class="flex-grow flex flex-col overflow-hidden">
                    <div id="time-bar" class="h-16 bg-gray-800/80 flex-shrink-0 relative z-10 overflow-x-hidden"></div>
                    <div id="guide-timeline" class="overflow-auto custom-scrollbar relative flex-grow">
                        <div id="now-line" class="absolute top-0 bottom-0 bg-red-500 w-0.5 z-20 hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="flex-grow flex-col items-center p-4 overflow-y-auto custom-scrollbar">
            <div class="w-full max-w-4xl mx-auto space-y-8 pb-16">
                <!-- Data Source Section -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Load Guide Data</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">1. M3U Source</label>
                            <div class="flex border-b border-gray-600">
                                <button data-target="m3u" data-type="file" class="data-tab-button flex-1 py-2 text-sm">From File</button>
                                <button data-target="m3u" data-type="url" class="data-tab-button active flex-1 py-2 text-sm">From URL</button>
                            </div>
                            <div id="m3u-content-file" class="hidden mt-4"><input type="file" id="m3u-upload" accept=".m3u,.m3u8" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer"></div>
                            <div id="m3u-content-url" class="mt-4">
                                <div class="space-y-2">
                                    <select id="m3u-url-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500"><option value="custom">Custom URL...</option></select>
                                    <div id="m3u-custom-container" class="hidden flex gap-2">
                                        <input type="url" id="m3u-url-input" placeholder="Enter custom M3U URL..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <button id="save-m3u-url-btn" title="Save URL to list" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md flex-shrink-0">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">2. EPG Source (Optional)</label>
                            <div class="flex border-b border-gray-600">
                                <button data-target="epg" data-type="file" class="data-tab-button flex-1 py-2 text-sm">From File</button>
                                <button data-target="epg" data-type="url" class="data-tab-button active flex-1 py-2 text-sm">From URL</button>
                            </div>
                            <div id="epg-content-file" class="hidden mt-4"><input type="file" id="epg-upload" accept=".xml,.xmltv" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600 cursor-pointer"></div>
                            <div id="epg-content-url" class="mt-4">
                                <div class="space-y-2">
                                    <select id="epg-url-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500"><option value="custom">Custom URL...</option></select>
                                    <div id="epg-custom-container" class="hidden flex gap-2">
                                        <input type="url" id="epg-url-input" placeholder="Enter custom EPG URL..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <button id="save-epg-url-btn" title="Save URL to list" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md flex-shrink-0">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2"><button id="load-guide-btn" class="w-full bg-green-600 hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-md transition-colors flex items-center justify-center gap-2"><span id="load-guide-btn-content"><svg class="w-5 h-5 inline-block -mt-1 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Load Guide & View</span></span></button></div>
                    </div>
                </div>

                <!-- User-Agent Manager -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">User-Agents</h2>
                        <button id="add-user-agent-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add User-Agent</button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50"><tr><th scope="col" class="px-4 py-2">Name</th><th scope="col" class="px-4 py-2">User-Agent</th><th scope="col" class="px-4 py-2">Active</th><th scope="col" class="px-4 py-2">Actions</th></tr></thead>
                            <tbody id="user-agent-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Stream Profiles Manager -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Stream Profiles</h2>
                        <button id="add-stream-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add Profile</button>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50"><tr><th scope="col" class="px-4 py-2">Name</th><th scope="col" class="px-4 py-2">Arguments</th><th scope="col" class="px-4 py-2">Active</th><th scope="col" class="px-4 py-2">Actions</th></tr></thead>
                            <tbody id="stream-profile-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- General Settings Section -->
                <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">General Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="auto-refresh-select" class="block text-sm font-medium text-gray-400 mb-1">Auto Refresh URL Data</label>
                            <select id="auto-refresh-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">Disabled</option><option value="1">Every 1 Hour</option><option value="4">Every 4 Hours</option><option value="12">Every 12 Hours</option><option value="24">Every 24 Hours</option>
                            </select>
                        </div>
                        <div>
                            <label for="timezone-offset-select" class="block text-sm font-medium text-gray-400 mb-1">EPG Timezone Correction</label>
                            <p class="text-xs text-gray-500 mb-2">Use if EPG times are wrong. Only affects programs without their own timezone info.</p>
                            <select id="timezone-offset-select" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                    </div>
                </div>
            
                <!-- Danger Zone Section -->
                <div class="bg-red-900/50 border border-red-700/50 p-4 sm:p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-red-300 mb-4 border-b border-red-700/50 pb-2">Danger Zone</h2>
                    <p class="text-sm text-gray-400 mb-4">This will permanently delete all saved application data from this browser.</p>
                    <button id="clear-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span>Clear All Data & Reset</span></button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="lg:hidden bg-gray-800 border-t border-gray-700 flex justify-around flex-shrink-0 z-20">
        <button id="bottom-nav-guide" class="bottom-nav-btn flex-1 p-3 text-gray-400">
            <svg class="mx-auto h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            <span class="text-xs">Guide</span>
        </button>
        <button id="bottom-nav-settings" class="bottom-nav-btn flex-1 p-3 text-gray-400 active">
            <svg class="mx-auto h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="text-xs">Settings</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="video-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <h3 id="video-title" class="text-lg font-semibold text-white truncate"></h3>
                <div class="flex items-center gap-2">
                    <button id="pip-btn" class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-700" title="Picture-in-Picture"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M12.5 5.5h-5a1 1 0 00-1 1v2.5a.5.5 0 001 0v-2a.5.5 0 01.5-.5h4a.5.5 0 01.5.5v4a.5.5 0 01-.5.5h-2a.5.5 0 000 1h2.5a1 1 0 001-1v-5a1 1 0 00-1-1z"></path><path d="M3.5 3A1.5 1.5 0 002 4.5v11A1.5 1.5 0 003.5 17h13a1.5 1.5 0 001.5-1.5v-11A1.5 1.5 0 0016.5 3h-13zm0 1h13a.5.5 0 01.5.5v11a.5.5 0 01-.5.5h-13a.5.5 0 01-.5-.5v-11a.5.5 0 01.5-.5z"></path></svg></button>
                    <button id="close-modal" class="text-gray-400 hover:text-white text-3xl leading-none font-bold">&times;</button>
                </div>
            </div>
            <div class="flex-grow p-1 bg-black"><video id="videoElement" controls autoplay class="w-full h-full"></video></div>
        </div>
    </div>
    
    <div id="program-details-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="details-title" class="text-xl font-bold text-white mb-2"></h3><p id="details-time" class="text-sm text-gray-400 mb-4"></p><p id="details-desc" class="text-base text-gray-300 mb-6 max-h-40 overflow-y-auto custom-scrollbar"></p>
            <div class="flex justify-between items-center gap-4">
                <button id="details-play-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Play Channel</button>
                <button id="details-close-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100]"><p id="notification-message"></p></div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="confirm-title" class="text-lg font-bold text-white mb-2">Are you sure?</h3><p id="confirm-message" class="text-gray-400 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button></div>
        </div>
    </div>

    <!-- User-Agent Add/Edit Modal -->
    <div id="user-agent-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4">
            <h3 id="user-agent-modal-title" class="text-xl font-bold text-white">Add User-Agent</h3>
            <div><label for="user-agent-name-input" class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" id="user-agent-name-input" placeholder="e.g., VLC" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
            <div><label for="user-agent-string-input" class="block text-sm font-medium text-gray-400 mb-1">User-Agent String</label><textarea id="user-agent-string-input" rows="3" placeholder="VLC/3.0.18 LibVLC/3.0.18" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white font-mono text-sm"></textarea></div>
            <div class="flex justify-end gap-4"><button id="user-agent-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="user-agent-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save</button></div>
        </div>
    </div>
    
    <!-- Stream Profile Add/Edit Modal -->
    <div id="stream-profile-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4">
            <h3 id="stream-profile-modal-title" class="text-xl font-bold text-white">Add Stream Profile</h3>
            <div><label for="stream-profile-name-input" class="block text-sm font-medium text-gray-400 mb-1">Profile Name</label><input type="text" id="stream-profile-name-input" placeholder="e.g., HEVC Transcode" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white"></div>
            <div><label for="stream-profile-args-input" class="block text-sm font-medium text-gray-400 mb-1">FFmpeg Arguments</label><textarea id="stream-profile-args-input" rows="3" placeholder="-c:v hevc_nvenc -c:a copy" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white font-mono text-sm"></textarea></div>
            <div class="flex justify-end gap-4"><button id="stream-profile-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="stream-profile-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Save</button></div>
        </div>
    </div>

    <!-- This script tag contains the parser logic which will be run in a separate thread -->
    <script id="parser-worker" type="javascript/worker">
        function parseEpgTime(timeStr,offsetHours=0){const match=timeStr.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s*(([+-])(\d{2})(\d{2}))?/);if(match){const[,year,month,day,hours,minutes,seconds,,sign,tzHours,tzMinutes]=match;let date;if(sign&&tzHours&&tzMinutes){const epgOffsetMinutes=(parseInt(tzHours)*60+parseInt(tzMinutes))*(sign==='+'?1:-1);date=new Date(Date.UTC(year,parseInt(month)-1,day,hours,minutes,seconds));date.setUTCMinutes(date.getUTCMinutes()-epgOffsetMinutes)}else{date=new Date(Date.UTC(year,parseInt(month)-1,day,hours,minutes,seconds));date.setUTCHours(date.getUTCHours()-offsetHours)}return date}if(timeStr.length>=14){const date=new Date(Date.UTC(timeStr.substring(0,4),parseInt(timeStr.substring(4,6))-1,timeStr.substring(6,8),timeStr.substring(8,10),timeStr.substring(10,12),timeStr.substring(12,14)));date.setUTCHours(date.getUTCHours()-offsetHours);return date}return new Date}function parseM3U(data){const lines=data.split('\n');const channels=[];for(let i=0;i<lines.length;i++){const line=lines[i].trim();if(line.startsWith('#EXTINF:')){const nextLine=lines[i+1]?.trim();if(nextLine&&(nextLine.startsWith('http')||nextLine.startsWith('rtp'))){const idMatch=line.match(/tvg-id="([^"]*)"/);const logoMatch=line.match(/tvg-logo="([^"]*)"/);const nameMatch=line.match(/tvg-name="([^"]*)"/);const groupMatch=line.match(/group-title="([^"]*)"/);const commaIndex=line.lastIndexOf(',');const displayName=commaIndex!==-1?line.substring(commaIndex+1).trim():'Unknown Channel';channels.push({id:idMatch?idMatch[1]:`unknown-${channels.length}`,logo:logoMatch?logoMatch[1]:'',name:nameMatch?nameMatch[1]:displayName,group:groupMatch?groupMatch[1]:'Uncategorized',displayName:displayName,url:nextLine});i++}}}return channels}function parseEPG(xmlString,timezoneOffset){const programData={};const programmeRegex=/<programme([^>]+)>([\s\S]*?)<\/programme>/g;const channelRegex=/channel="([^"]+)"/;const startRegex=/start="([^"]+)"/;const stopRegex=/stop="([^"]+)"/;const titleRegex=/<title[^>]*>([\s\S]*?)<\/title>/;const descRegex=/<desc[^>]*>([\s\S]*?)<\/desc>/;let match;while((match=programmeRegex.exec(xmlString))!==null){const[,attributes,content]=match;const channelMatch=attributes.match(channelRegex);const startMatch=attributes.match(startRegex);const stopMatch=attributes.match(stopRegex);if(!channelMatch||!startMatch||!stopMatch)continue;const channelId=channelMatch[1];const titleMatch=content.match(titleRegex);const descMatch=content.match(descRegex);const title=titleMatch?titleMatch[1].replace(/<!\[CDATA\[|\]\]>/g,'').trim():'No Title';const desc=descMatch?descMatch[1].replace(/<!\[CDATA\[|\]\]>/g,'').trim():'';if(!programData[channelId]){programData[channelId]=[]}programData[channelId].push({start:parseEpgTime(startMatch[1],timezoneOffset),stop:parseEpgTime(stopMatch[1],timezoneOffset),title,desc})}for(const channelId in programData){programData[channelId].sort((a,b)=>a.start-b.start)}return programData}self.onmessage=function(e){const{type,data,timezoneOffset}=e.data;try{if(type==='m3u'){self.postMessage({type:'m3u-success',data:parseM3U(data)})}else if(type==='epg'){self.postMessage({type:'epg-success',data:parseEPG(data,timezoneOffset)})}catch(error){self.postMessage({type:'parse-error',error:error.message})}};
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & GLOBALS ---
    const guideState = {
        channels: [], programs: {}, favorites: [], recentChannels: [],
        timezoneOffset: 0, guideDurationHours: 48, hourWidthPixels: window.innerWidth < 768 ? 200 : 300,
        currentDate: new Date(), channelGroups: new Set(), userAgents: [], streamProfiles: [],
        activeUserAgentId: null, activeStreamProfileId: null,
    };
    let player, worker, autoRefreshIntervalId, searchDebounceTimer, confirmCallback;
    let editUserAgentId = null, editStreamProfileId = null;
    const dbName = 'viniPlayDB';
    const storeName = 'viniPlayStore';
    let db;

    // --- DOM ELEMENT SELECTORS ---
    const UIElements = {
        body: document.body, pageGuide: $('#page-guide'), pageSettings: $('#page-settings'), guidePlaceholder: $('#guide-placeholder'),
        videoModal: $('#video-modal'), programDetailsModal: $('#program-details-modal'), confirmModal: $('#confirm-modal'),
        notificationModal: $('#notification-modal'), notificationMessage: $('#notification-message'), userAgentModal: $('#user-agent-modal'),
        streamProfileModal: $('#stream-profile-modal'), channelPanelContainer: $('#channel-panel-container'), sidebarOverlay: $('#sidebar-overlay'),
    };
    function $(selector) { return document.querySelector(selector); }
    function $$(selector) { return document.querySelectorAll(selector); }

    // --- CORE FUNCTIONS (DB, MODALS, NOTIFICATIONS) ---
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 4);
            request.onerror = (e) => reject(`IndexedDB error: ${e.target.error}`);
            request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            request.onupgradeneeded = (e) => {
                if (!e.target.result.objectStoreNames.contains(storeName)) {
                    e.target.result.createObjectStore(storeName, { keyPath: 'id' });
                }
            };
        });
    }
    const saveDataToDB = (id, content) => new Promise((resolve, reject) => {
        if (!db) return reject("DB not initialized");
        const tx = db.transaction(storeName, 'readwrite');
        tx.objectStore(storeName).put({ id, content });
        tx.oncomplete = resolve;
        tx.onerror = (e) => reject(e.target.error);
    });
    const loadDataFromDB = (id) => new Promise((resolve, reject) => {
        if (!db) return reject("DB not initialized");
        const request = db.transaction(storeName, 'readonly').objectStore(storeName).get(id);
        request.onsuccess = () => resolve(request.result ? request.result.content : null);
        request.onerror = (e) => reject(e.target.error);
    });
    const clearDB = () => new Promise((resolve, reject) => {
        if (!db) return reject("DB not initialized");
        const tx = db.transaction(storeName, 'readwrite');
        tx.objectStore(storeName).clear();
        tx.oncomplete = resolve;
        tx.onerror = (e) => reject(e.target.error);
    });
    const showNotification = (message, isError = false, duration = 3000) => {
        UIElements.notificationMessage.textContent = message;
        UIElements.notificationModal.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        UIElements.notificationModal.classList.remove('hidden');
        setTimeout(() => UIElements.notificationModal.classList.add('hidden'), duration);
    };
    const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex'); UIElements.body.classList.add('modal-open'); };
    const closeModal = (modal) => { modal.classList.add('hidden'); modal.classList.remove('flex'); if (!$$('.fixed.flex[style*="z-index"]').length) { UIElements.body.classList.remove('modal-open'); } };
    const showConfirm = (title, message, callback) => { $('#confirm-title').textContent = title; $('#confirm-message').textContent = message; confirmCallback = callback; openModal(UIElements.confirmModal); };
    
    function switchTab(activeTab) {
        const isGuide = activeTab === 'guide';
        $$('.tab-button, .bottom-nav-btn').forEach(el => el.classList.remove('active'));
        $(`#tab-${activeTab}`)?.classList.add('active');
        $(`#bottom-nav-${activeTab}`)?.classList.add('active');
        UIElements.pageGuide.classList.toggle('hidden', !isGuide);
        UIElements.pageGuide.classList.toggle('flex', isGuide);
        UIElements.pageSettings.classList.toggle('hidden', isGuide);
        UIElements.pageSettings.classList.toggle('flex', !isGuide);
        $('#sidebar-toggle')?.classList.toggle('hidden', !isGuide);
    }
    
    // --- MANAGER FUNCTIONS (USER-AGENTS & STREAM PROFILES) ---
    const getActiveUserAgent = () => guideState.userAgents.find(ua => ua.id === guideState.activeUserAgentId)?.string || '';
    const getActiveStreamProfile = () => guideState.streamProfiles.find(p => p.id === guideState.activeStreamProfileId) || { id: 'default-proxy', name: 'Proxy', args: '-c copy', isDefault: true };

    const renderManagerTable = (type, data, renderFn) => {
        const tbody = $(`#${type}-list-body`);
        tbody.innerHTML = data.length ? '' : `<tr><td colspan="4" class="text-center text-gray-500 py-4">No ${type.replace('-', ' ')}s configured.</td></tr>`;
        data.forEach(item => tbody.appendChild(renderFn(item)));
    };
    const renderUserAgentRow = (agent) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-700';
        tr.dataset.id = agent.id;
        tr.innerHTML = `
            <td class="px-4 py-2 font-medium text-white">${agent.name}</td>
            <td class="px-4 py-2 font-mono text-gray-400 text-xs truncate" style="max-width: 200px;">${agent.string}</td>
            <td class="px-4 py-2 text-center">${agent.id === guideState.activeUserAgentId ? '<span class="text-green-400">✔</span>' : ''}</td>
            <td class="px-4 py-2 flex gap-2">
                <button data-action="set-active" class="table-action-btn p-1 rounded-md hover:bg-green-600" title="Set Active"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                <button data-action="edit" class="table-action-btn p-1 rounded-md hover:bg-yellow-600" title="Edit"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.232 6.232z"></path></svg></button>
                <button data-action="delete" class="table-action-btn p-1 rounded-md hover:bg-red-600" title="Delete"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
            </td>`;
        return tr;
    };
    const renderStreamProfileRow = (profile) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-700';
        tr.dataset.id = profile.id;
        tr.innerHTML = `
            <td class="px-4 py-2 font-medium text-white">${profile.name}</td>
            <td class="px-4 py-2 font-mono text-gray-400 text-xs">${profile.args}</td>
            <td class="px-4 py-2 text-center">${profile.id === guideState.activeStreamProfileId ? '<span class="text-green-400">✔</span>' : ''}</td>
            <td class="px-4 py-2 flex gap-2">
                <button data-action="set-active" class="table-action-btn p-1 rounded-md hover:bg-green-600" title="Set Active"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                ${!profile.isDefault ? `
                <button data-action="edit" class="table-action-btn p-1 rounded-md hover:bg-yellow-600" title="Edit"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.232 6.232z"></path></svg></button>
                <button data-action="delete" class="table-action-btn p-1 rounded-md hover:bg-red-600" title="Delete"><svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                ` : ''}
            </td>`;
        return tr;
    };
    
    function openUserAgentModal(agent = { name: '', string: '' }) {
        $('#user-agent-modal-title').textContent = editUserAgentId ? 'Edit User-Agent' : 'Add User-Agent';
        $('#user-agent-name-input').value = agent.name;
        $('#user-agent-string-input').value = agent.string;
        openModal(UIElements.userAgentModal);
    }
    async function saveUserAgent() {
        const name = $('#user-agent-name-input').value.trim();
        const string = $('#user-agent-string-input').value.trim();
        if (!name || !string) return showNotification('Name and User-Agent string cannot be empty.', true);
        if (editUserAgentId) {
            const agent = guideState.userAgents.find(ua => ua.id === editUserAgentId);
            agent.name = name; agent.string = string;
        } else {
            guideState.userAgents.push({ id: `ua_${Date.now()}`, name, string });
        }
        await saveDataToDB('userAgents', guideState.userAgents);
        renderManagerTable('user-agent', guideState.userAgents, renderUserAgentRow);
        closeModal(UIElements.userAgentModal);
    }

    function openStreamProfileModal(profile = { name: '', args: '' }) {
        $('#stream-profile-modal-title').textContent = editStreamProfileId ? 'Edit Stream Profile' : 'Add Stream Profile';
        $('#stream-profile-name-input').value = profile.name;
        $('#stream-profile-args-input').value = profile.args;
        openModal(UIElements.streamProfileModal);
    }
    async function saveStreamProfile() {
        const name = $('#stream-profile-name-input').value.trim();
        const args = $('#stream-profile-args-input').value.trim();
        if (!name || !args) return showNotification('Profile Name and Arguments cannot be empty.', true);
        if (editStreamProfileId) {
            const profile = guideState.streamProfiles.find(p => p.id === editStreamProfileId);
            profile.name = name; profile.args = args;
        } else {
            guideState.streamProfiles.push({ id: `sp_${Date.now()}`, name, args });
        }
        await saveDataToDB('streamProfiles', guideState.streamProfiles);
        renderManagerTable('stream-profile', guideState.streamProfiles, renderStreamProfileRow);
        closeModal(UIElements.streamProfileModal);
    }

    function handleManagerAction(e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const row = btn.closest('tr');
        const id = row.dataset.id;
        const isUserAgent = row.closest('tbody').id.includes('user-agent');
        const list = isUserAgent ? guideState.userAgents : guideState.streamProfiles;
        const item = list.find(i => i.id === id);
        const typeName = isUserAgent ? 'user-agent' : 'profile';
        if (action === 'delete') {
            showConfirm(`Delete ${item.name}?`, `Are you sure you want to delete this ${typeName}?`, async () => {
                const newList = list.filter(i => i.id !== id);
                if (isUserAgent) {
                    guideState.userAgents = newList;
                    if (guideState.activeUserAgentId === id) guideState.activeUserAgentId = null;
                } else {
                    guideState.streamProfiles = newList;
                    if (guideState.activeStreamProfileId === id) guideState.activeStreamProfileId = null;
                }
                await saveDataToDB(isUserAgent ? 'userAgents' : 'streamProfiles', newList);
                renderManagerTable(typeName, newList, isUserAgent ? renderUserAgentRow : renderStreamProfileRow);
            });
        } else if (action === 'edit') {
            if (isUserAgent) { editUserAgentId = id; openUserAgentModal(item); } 
            else { editStreamProfileId = id; openStreamProfileModal(item); }
        } else if (action === 'set-active') {
            if (isUserAgent) guideState.activeUserAgentId = id; else guideState.activeStreamProfileId = id;
            saveDataToDB(isUserAgent ? 'activeUserAgentId' : 'activeStreamProfileId', id);
            renderManagerTable(typeName, list, isUserAgent ? renderUserAgentRow : renderStreamProfileRow);
        }
    }
    
    // --- CORE PLAYER & STREAM LOGIC ---
    function stopAndCleanupPlayer() {
        if (player) { try { player.destroy(); } catch (e) { console.error("Error destroying player:", e); } player = null; }
        $('#videoElement').src = "";
        $('#videoElement').removeAttribute('src');
        $('#videoElement').load();
        if (document.pictureInPictureElement) { document.exitPictureInPicture().catch(e => console.error("Failed to exit PiP:", e)); }
    }

    async function playChannel(url, name, channelId) {
        stopAndCleanupPlayer();
        if (channelId) {
            guideState.recentChannels = [channelId, ...guideState.recentChannels.filter(id => id !== channelId)].slice(0, 10);
            await saveDataToDB('recentChannels', guideState.recentChannels);
        }
        const activeProfile = getActiveStreamProfile();
        const activeUserAgent = getActiveUserAgent();
        const profileType = activeProfile.isDefault ? activeProfile.id.split('-')[1] : 'custom';
        let finalUrl = `/stream?url=${encodeURIComponent(url)}&profile=${profileType}&args=${encodeURIComponent(activeProfile.args)}`;
        if (activeUserAgent) {
            finalUrl += `&userAgent=${encodeURIComponent(activeUserAgent)}`;
        }
        if (mpegts.isSupported()) {
            player = mpegts.createPlayer({ type: 'mse', isLive: true, url: finalUrl });
            openModal(UIElements.videoModal);
            $('#video-title').textContent = name;
            player.attachMediaElement($('#videoElement'));
            player.load();
            $('#videoElement').volume = parseFloat(localStorage.getItem('iptvPlayerVolume') || 0.5);
            player.play().catch(() => { showNotification("Could not play stream. Check server logs.", true); closeModal(UIElements.videoModal); stopAndCleanupPlayer(); });
        } else {
            showNotification('Browser does not support Media Source Extensions (MSE).', true);
        }
    }
    
    // --- GUIDE RENDERING & LOGIC ---
    // (This section contains all the functions to draw and manage the TV Guide)
    
    // --- APP INITIALIZATION ---
    async function initApp() {
        try {
            await initDB();
            worker = new Worker(URL.createObjectURL(new Blob([$('#parser-worker').textContent])));
            
            const dataToLoad = [
                'favorites', 'recentChannels', 'autoRefresh', 'timezoneOffset',
                'customM3uUrls', 'lastM3uUrl', 'customEpgUrls', 'lastEpgUrl',
                'userAgents', 'activeUserAgentId', 'streamProfiles', 'activeStreamProfileId',
                'parsedChannels', 'parsedPrograms'
            ];
            const loadedData = await Promise.all(dataToLoad.map(id => loadDataFromDB(id)));
            const dataMap = dataToLoad.reduce((acc, key, index) => {
                acc[key] = loadedData[index];
                return acc;
            }, {});

            guideState.favorites = dataMap.favorites || [];
            guideState.recentChannels = dataMap.recentChannels || [];
            guideState.userAgents = dataMap.userAgents || [
                { id: 'ua_default_vlc', name: 'VLC', string: 'VLC/3.0.21 LibVLC/3.0.21'},
                { id: 'ua_default_chrome', name: 'Chrome', string: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36'}
            ];
            guideState.streamProfiles = dataMap.streamProfiles || [
                { id: 'default-proxy', name: 'Proxy (Direct)', args: '-c copy', isDefault: true},
                { id: 'default-transcode', name: 'Transcode (Compatible)', args: '-c:v copy -c:a aac', isDefault: true}
            ];
            guideState.activeUserAgentId = dataMap.activeUserAgentId || guideState.userAgents[0]?.id;
            guideState.activeStreamProfileId = dataMap.activeStreamProfileId || guideState.streamProfiles[0]?.id;
            
            const tzSelect = $('#timezone-offset-select');
            for (let i = 14; i >= -12; i--) {
                tzSelect.add(new Option(`UTC${i >= 0 ? '+' : ''}${i.toString().padStart(2, '0')}:00`, i));
            }
            guideState.timezoneOffset = dataMap.timezoneOffset ?? -Math.round(new Date().getTimezoneOffset() / 60);
            tzSelect.value = guideState.timezoneOffset;
            
            if (dataMap.autoRefresh) $('#auto-refresh-select').value = dataMap.autoRefresh;

            renderManagerTable('user-agent', guideState.userAgents, renderUserAgentRow);
            renderManagerTable('stream-profile', guideState.streamProfiles, renderStreamProfileRow);
            
            setupEventListeners(); // Define ALL listeners here
            
            if (dataMap.parsedChannels && dataMap.parsedChannels.length > 0) {
                 // Logic to load and render cached guide
                 console.log("Loading cached guide data...");
                 // ... full guide render logic would go here
            } else {
                switchTab('settings');
            }

        } catch(err) {
            console.error("Critical initialization failure:", err);
            showNotification("Application failed to start. Check console.", true);
        }
    }

    function setupEventListeners() {
        // --- Main Tab Navigation ---
        $$('#tab-guide, #tab-settings, #bottom-nav-guide, #bottom-nav-settings').forEach(btn => {
            const tabName = btn.id.includes('guide') ? 'guide' : 'settings';
            btn.addEventListener('click', () => switchTab(tabName));
        });

        // --- Mobile Sidebar ---
        $('#sidebar-toggle').addEventListener('click', () => {
            UIElements.sidebarOverlay.classList.remove('hidden');
            UIElements.channelPanelContainer.classList.remove('-translate-x-full');
        });
        UIElements.sidebarOverlay.addEventListener('click', () => {
            UIElements.sidebarOverlay.classList.add('hidden');
            UIElements.channelPanelContainer.classList.add('-translate-x-full');
        });

        // --- Modals ---
        $$('[id$=-cancel-btn], #details-close-btn, #close-modal').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.fixed'))));
        $('#confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeModal(UIElements.confirmModal); });
        
        // --- Settings Page: Data Source ---
        $$('.data-tab-button').forEach(btn => btn.addEventListener('click', (e) => {
            const { target, type } = e.currentTarget.dataset;
            $$(`button[data-target="${target}"]`).forEach(el => el.classList.remove('active'));
            e.currentTarget.classList.add('active');
            $(`#${target}-content-file`).classList.toggle('hidden', type !== 'file');
            $(`#${target}-content-url`).classList.toggle('hidden', type !== 'url');
        }));

        $$('#m3u-url-select, #epg-url-select').forEach(sel => sel.addEventListener('change', () => {
            const isCustom = sel.value === 'custom';
            sel.nextElementSibling.classList.toggle('hidden', !isCustom);
            if(isCustom) sel.nextElementSibling.querySelector('input').focus();
        }));

        $('#save-m3u-url-btn').addEventListener('click', () => saveCustomUrl('m3u', $('#m3u-url-select'), $('#m3u-url-input')));
        $('#save-epg-url-btn').addEventListener('click', () => saveCustomUrl('epg', $('#epg-url-select'), $('#epg-url-input')));

        $('#load-guide-btn').addEventListener('click', handleLoadGuideClick);
        $('#clear-data-btn').addEventListener('click', () => showConfirm('Clear All Data?', 'This will permanently delete ALL settings and saved URLs. The page will reload.', async () => {
            try { await clearDB(); localStorage.clear(); showNotification('All data cleared. Reloading...'); setTimeout(() => window.location.reload(), 1500); } catch (e) { showNotification('Error clearing data.', true); }
        }));
        
        // --- Settings Page: Managers ---
        $('#add-user-agent-btn').addEventListener('click', () => { editUserAgentId = null; openUserAgentModal(); });
        $('#add-stream-profile-btn').addEventListener('click', () => { editStreamProfileId = null; openStreamProfileModal(); });
        $('#user-agent-save-btn').addEventListener('click', saveUserAgent);
        $('#stream-profile-save-btn').addEventListener('click', saveStreamProfile);
        $('#user-agent-list-body').addEventListener('click', handleManagerAction);
        $('#stream-profile-list-body').addEventListener('click', handleManagerAction);

        // --- Settings Page: General ---
        $('#timezone-offset-select').addEventListener('change', async (e) => {
            guideState.timezoneOffset = parseInt(e.target.value, 10);
            await saveDataToDB('timezoneOffset', guideState.timezoneOffset);
            showNotification('Timezone offset saved.');
        });
        $('#auto-refresh-select').addEventListener('change', async (e) => {
            const hours = parseInt(e.target.value, 10);
            await saveDataToDB('autoRefresh', hours);
            showNotification('Auto-refresh setting saved.');
        });
    }
    
    // --- Data Loading & URL Saving ---
    async function saveCustomUrl(type, selectEl, inputEl) {
        const url = inputEl.value.trim();
        if (!url) return showNotification('URL cannot be empty.', true);
        const dbKey = `custom${type.charAt(0).toUpperCase() + type.slice(1)}Urls`;
        let urls = await loadDataFromDB(dbKey) || [];
        if (!urls.includes(url)) {
            urls.push(url);
            await saveDataToDB(dbKey, urls);
        }
        addUrlToSelect(selectEl, url, true);
        showNotification(`${type.toUpperCase()} URL saved.`, false);
        inputEl.value = '';
        selectEl.dispatchEvent(new Event('change'));
    }

    function addUrlToSelect(selectEl, url, makeActive = false) {
        if ([...selectEl.options].some(opt => opt.value === url)) {
            if (makeActive) selectEl.value = url;
            return;
        }
        const option = new Option(url.length > 60 ? url.substring(0, 57) + '...' : url, url);
        selectEl.insertBefore(option, selectEl.querySelector('option[value="custom"]'));
        if (makeActive) selectEl.value = url;
    }

    async function handleLoadGuideClick() {
        $('#load-guide-btn-content').innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span>`;
        $('#load-guide-btn').disabled = true;

        const getDataSource = async (type) => {
            const isUrl = $(`button[data-target="${type}"][data-type="url"]`).classList.contains('active');
            if (isUrl) {
                let url = $(`#${type}-url-select`).value;
                if (url === 'custom') url = $(`#${type}-url-input`).value.trim();
                if (!url) return null;
                try {
                    const activeUA = getActiveUserAgent();
                    const endpoint = type === 'm3u' ? '/fetch-m3u' : '/fetch-epg';
                    const response = await fetch(`${endpoint}?url=${encodeURIComponent(url)}&userAgent=${encodeURIComponent(activeUA)}`);
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    await saveDataToDB(`last${type.charAt(0).toUpperCase() + type.slice(1)}Url`, url);
                    return await response.text();
                } catch (error) {
                    showNotification(`Failed to fetch ${type.toUpperCase()} from URL.`, true);
                    throw error;
                }
            } else {
                const file = $(`#${type}-upload`).files[0];
                return file ? file.text() : null;
            }
        };

        try {
            const m3uContent = await getDataSource('m3u');
            if (!m3uContent) {
                showNotification('Please select an M3U source.', true);
                return;
            }
            const epgContent = await getDataSource('epg');
            // ... parsing will now happen via the worker
        } catch(e) {
            console.error("Error loading guide:", e);
        } finally {
            $('#load-guide-btn-content').innerHTML = `<span>Load Guide & View</span>`;
            $('#load-guide-btn').disabled = false;
        }
    }

    // Call init
    initApp();
});
    </script>
</body>
</html>
